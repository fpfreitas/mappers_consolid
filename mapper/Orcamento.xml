<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Orcamento">
  

  <select id="selectOrcamento" resultMap="OrcaJsonResult">
  	<![CDATA[
	
	 SELECT 'estOrc' 				AS "tipoRegistro",
			orc.cd_emp              ,
			orc.cd_filial           ,
            orc.cd_orc              ,
            orc.vd_troca_fidel      ,
            orc.cd_cli              ,
            orc.cd_conv             ,
            orc.qt_parc_conv        ,
            orc.nr_ped_televd       ,
            orc.tipo_prazo_pgto     ,
            orc.nr_cartao_pbm       ,
            orc.cd_projeto_pbm      ,
            orc.tp_perc_rec_conv    ,
            orc.perc_rec_conv       ,
            orc.dados_adicionais    ,
            orc.nm_comprador        ,
            orc.qtd_dias_prorrog    ,
            orc.tipo_pbm            ,
            orc.cd_cli_dep          ,
            orc.vlr_prod            ,
            orc.tp_orc_entg         ,
            2		      AS sts_orc, 
            orc.nm_cli              ,
            orc.nr_autr_pbm         ,
            orc.cpf_cli_pbm         ,
            orc.dt_emi              ,
            orc.hr_emi              ,
            orc.vlr_tot             ,
			orc.vlr_desc			,
			orc.vlr_desc_geral		,
            orc.nr_cartao_fidelidade,
            orc.fone_cli            ,
            orc.tp_orc              ,
            orc.cd_frm_pgto         ,
            orc.orig_orc            ,
            orc.obs                 ,
            COALESCE(est_cancel.cd_mt_cancel_orc, 0) AS cd_mt_cancel_orc,
            est_cancel.desc_mt_cancel             			
			FROM      est_orc orc 
                 left join est_orc_mt_cancel est_cancel 
                 ON        est_cancel.cd_emp::   NUMERIC = orc.cd_emp::NUMERIC 
                 AND       est_cancel.cd_filial::NUMERIC = orc.cd_filial::NUMERIC 
                 AND       est_cancel.cd_orc::   NUMERIC = orc.cd_orc::NUMERIC 
				 left join pdv_vd vd on
				 vd.cd_emp          = orc.cd_emp
				 and vd.cd_filial   = orc.cd_filial
				 and vd.nr_orc      = orc.cd_orc
                 where orc.flag_consolidado = 0
				  AND hr_emi < (now() - interval '90 minutes') 
				  AND VD.CD_EMP IS NULL 
				  LIMIT 1			 
				 	]]>

	</select>	
	
	<select id="selectOrcamentoItem" resultMap="OrcamentoItem">                    
    SELECT    est_orc_cpl.cd_prod                 ,
              est_orc_cpl.cd_barra                ,
              est_orc_cpl.cd_emp                  ,
              est_orc_cpl.cd_filial               ,
              est_orc_cpl.qt                      ,
              est_orc_cpl.vlr_it                  ,
              est_orc_cpl.vlr_tot_it              ,
              est_orc_cpl.vlr_desc                ,
              est_orc_cpl.perc_desc               ,
              est_orc_cpl.cd_medico_rec           ,
              est_orc_cpl.cd_vend                 ,
              est_orc_cpl.cd_vend_lib             ,
              est_orc_cpl.pr_tab                  ,
              est_orc_cpl.nr_autr_pbm_item        ,
              est_orc_cpl.cd_vend_verba           ,
              est_orc_cpl.libera_vd_conv          ,
              est_orc_cpl.cd_it                   ,
              est_orc_cpl.perc_desc_min           ,
              est_orc_cpl.perc_desc_max           ,
              est_orc_cpl.cd_tbl_desc             ,
              est_orc_cpl.oferta                  ,
              est_orc_cpl.perc_desc_cad           ,
              est_orc_cpl.perc_desc_fix           ,
              est_orc_cpl.vlr_desc_fix            ,
              est_orc_cpl.tipo_desconto           ,
              est_orc_cpl.vlr_economia            ,
              est_orc_cpl.venda_dependente        ,
              est_orc_cpl.perc_desconto_pos_pbm   ,
              est_orc_cpl.nr_protocolo_manipulado ,
              est_orc_cpl.tipo_desconto           ,
              est_orc_cpl.qtde_ponto_fidel        ,
              est_orc_cpl.vlr_desc_verba          ,
              est_orc_cpl.perc_desc_verba         ,
              est_orc_cpl.cd_vend_verba           ,
              est_orc_cpl.vlr_custo_semaforo      ,
              est_orc_cpl.qt_est                  ,
              est_orc_cpl.cd_orc                  ,
              est_orc_cpl.cd_grp                  
	 FROM      est_orc_cpl 
	   left join est_orc_cpl_concor desconto_concorrente
	   ON        est_orc_cpl.cd_emp = desconto_concorrente.cd_emp::      NUMERIC
	   AND       est_orc_cpl.cd_filial = desconto_concorrente.cd_filial::NUMERIC
	   AND       est_orc_cpl.cd_orc = desconto_concorrente.nr_orc::      NUMERIC
	   AND       est_orc_cpl.cd_it = desconto_concorrente.cd_it::        NUMERIC
	   AND       est_orc_cpl.cd_prod = desconto_concorrente.cd_prod::    NUMERIC
	   WHERE     est_orc_cpl.cd_emp = #{cdEmp} 
	   AND       est_orc_cpl.cd_filial = #{cdFilial}
	   AND       est_orc_cpl.cd_orc = #{cdOrc}
	
		</select>
	
	<select id="selectOrcamentoItemConcorrente" resultMap="OrcamentoItemConcorrente"> 
		SELECT desconto_concorrente.cd_prod                ,
               desconto_concorrente.nr_orc                 ,
               desconto_concorrente.cd_vend                ,
               desconto_concorrente.cd_concor              ,
               desconto_concorrente.vlr_concor             ,
               desconto_concorrente.perc_desc              ,
               desconto_concorrente.cd_it                  
               from est_orc_cpl_concor desconto_concorrente
               WHERE     #{cdEmp}= desconto_concorrente.cd_emp::      NUMERIC
               AND       #{cdFilial} = desconto_concorrente.cd_filial::NUMERIC
               AND       #{cdOrc} = desconto_concorrente.nr_orc::      NUMERIC
               AND       #{cdIt} = desconto_concorrente.cd_it::        NUMERIC
               AND       #{cdProd} = desconto_concorrente.cd_prod::    NUMERIC
	</select>  
		
     <select id="selectOrcamentoItemLote" resultMap="OrcamentoItemLote">     

	 SELECT lote.cd_lote   ,
            lote.qtde_lote 
     FROM   est_orc_cpl_lote lote
     WHERE  #{cdEmp}   = lote.cd_emp::      NUMERIC
     AND    #{cdFilial}= lote.cd_filial::NUMERIC
     AND    #{cdOrc}   = lote.cd_orc::      NUMERIC
     AND    #{cdProd}  = lote.cd_prod::    NUMERIC
     AND    #{cdIt}    = lote.cd_it::        NUMERIC 
	 
	 </select>
	
	
	
	<select id="selectOrcamentoReceita" resultMap="OrcamentoReceita">     

	 SELECT receita.cd_prod                   ,
            receita.cd_it                     ,
            receita.nm_comprador              ,
            receita.idade                     ,
            receita.nm_paciente               ,
            receita.receita_tipo              ,
            coalesce(receita.cid, 0)          AS cid,
            receita.uf                        ,
            receita.nr_doc_cli                ,
            receita.tipo_documento            ,
            coalesce(receita.cd_medico_rec,0) AS cd_medico_rec,
            receita.qt_prod                   ,
            receita.dt_receita                ,
            receita.tp_capt_receita           
     FROM   est_orc_glb_medico receita 
     WHERE  receita.cd_emp = #{cdEmp}
     AND    receita.cd_filial = #{cdFilial}
     AND    receita.nr_orc = #{cdOrc}
	 
	 </select>
	
	<resultMap id="OrcaJsonResult" type="Map">
    <result property="cd_emp" column="cdEmp"/>
	<result property="cd_filial" column="cdFilial"/>
	<result property="cd_orc" column="cdOrc"/>
	<result property="vd_troca_fidel" column="vdTrocaFidel"/>
	<result property="cd_conv" column="cdConv"/>
	<result property="qt_parc_conv" column="qtParcConv"/>
	<result property="nr_ped_televd" column="nrPedTelevd"/>
	<result property="tipo_prazo_pgto" column="tipoPrazoPgto"/>
	<result property="nr_cartao_pbm" column="nrCartaoPbm"/>
	<result property="cd_projeto_pbm" column="cdProjetoPbm"/>
	<result property="tp_perc_rec_conv" column="tpPercRecConv"/>
	<result property="perc_rec_conv" column="percRecConv"/>
	<result property="dados_adicionais" column="dadosAdicionais"/>
	<result property="nm_comprador" column="nmComprador"/>
	<result property="qtd_dias_prorrog" column="qtdDiasProrrog"/>
	<result property="tipo_pbm" column="tipoPbm"/>
	<result property="cd_cli_dep" column="cdCliDep"/>
	<result property="vlr_prod" column="vlrProd"/>
	<result property="cd_cli" column="tpOrcEntg"/>
	<result property="sts_orc" column="stsOrc"/>
	<result property="nm_cli" column="nmCli"/>
	<result property="nr_autr_pbm" column="nrAutrPbm"/>
	<result property="cpf_cli_pbm" column="cpfCliPbm"/>
	<result property="dt_emi" column="dtEmi"/>
	<result property="hr_emi" column="hrEmi"/>
	<result property="vlr_tot" column="vlrTot"/>
	<result property="vlr_desc" column="vlrDesc"/>
	<result property="vlr_desc_geral" column="vlrDescGeral"/>
	<result property="nr_carta" column="nrCartaoCli"/>
	<result property="cd_cli" column="foneCli"/>
	<result property="cd_cli" column="tpOrc"/>
	<result property="cd_cli" column="cdFrmPgto"/>
	<result property="cd_cli" column="origOrc"/>
	<result property="obs" column="obs"/>
	<result property="cd_mt_cancel_orc" column="cdMtCancelOrc"/>
	<result property="cd_cli" column="descMtCancel"/>	
	<result property="tipoRegistro" column="tipoRegistro"/>	
	<collection property="itens" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdOrc=CD_ORC}" javaType="ArrayList" ofType="map" select="selectOrcamentoItem" />
	<collection property="receita" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdOrc = CD_ORC}" javaType="ArrayList" ofType="map" select="selectOrcamentoReceita" />
  </resultMap>	
		
	<resultMap id="OrcamentoItem" type="Map">
		<result property="cd_emp"                  column="cdEmp"/>
		<result property="cd_prod"                 column="cdProd"/>
        <result property="cd_barra"                column="cdBarra"/>
        <result property="qt"                      column="qt"/>
        <result property="vlr_it"                  column="vlrIt"/>
        <result property="vlr_tot_it"              column="vlrTotIt"/>
        <result property="vlr_desc"                column="vlrDesc"/>
        <result property="perc_desc"               column="percDesc"/>
        <result property="cd_medico_rec"           column="cdMedicoRec"/>
        <result property="cd_vend"                 column="cdVend"/>
        <result property="cd_vend_lib"             column="cdVendLib"/>
        <result property="pr_tab"                  column="prTab"/>
        <result property="nr_autr_pbm_item"        column="nrAutrPbmItem"/>
        <result property="cd_vend_verba"           column="cdVendVerba"/>
        <result property="libera_vd_conv"          column="liberaVdConv" />
        <result property="cd_it"                   column="cdIt"/>
        <result property="perc_desc_min"           column="percDescMin"/>
        <result property="perc_desc_max"           column="percDescMax"/>
        <result property="cd_tbl_desc"             column="cdTblDesc"/>
        <result property="oferta"                  column="oferta"/>
        <result property="perc_desc_cad"           column="percDescCad"/>
        <result property="perc_desc_fix"           column="percDescFix"/>
        <result property="vlr_desc_fix"            column="vlrDescFix"/>
        <result property="tipo_desconto"           column="tipoDesconto"/>
        <result property="vlr_economia"            column="vlrEconomia"/>
        <result property="venda_dependente"        column="vendaDependente"/>
        <result property="perc_desconto_pos_pbm"   column="percDescontoPosPbm"/>
        <result property="nr_protocolo_manipulado" column="nrProtocoloManipulado"/>
        <result property="tipo_desconto"           column="tpDesc"/>
        <result property="qtde_ponto_fidel"        column="qtPontosFidel"/>
        <result property="vlr_desc_verba"          column="vlrDescVerba"/>
        <result property="perc_desc_verba"         column="percDescVerba"/>
        <result property="cd_vend_verba"           column="cdVendVerba"/>
        <result property="vlr_custo_semaforo"      column="vlrCustoSemaforo"/>
        <result property="qt_est"                  column="qtEst"/>
        <result property="cd_grp"                  column="cdGrupoComissao"/>	
		<collection property="concorrente" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdOrc = CD_ORC,cdProd = CD_PROD,cdIt = CD_IT}" javaType="ArrayList" ofType="map" select="selectOrcamentoItemConcorrente" />
		<collection property="lote" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdOrc = CD_ORC,cdProd = CD_PROD,cdIt = CD_IT}" javaType="ArrayList" ofType="map" select="selectOrcamentoItemLote" />
	</resultMap>
	
	<resultMap id="OrcamentoItemConcorrente" type="Map">
		<result property="cd_prod"                column="cdProd"/>
        <result property="nr_orc"                 column="nrOrc"/>
        <result property="cd_vend"                column="cdVend"/>
        <result property="cd_concor"              column="cdConcorrente"/>
        <result property="vlr_concor"             column="vlrConcorrente"/>
        <result property="perc_desc"              column="percDesc"/>
        <result property="cd_it"                  column="cdIt"/>
	</resultMap>
	
    <resultMap id="OrcamentoReceita" type="Map">
			<result property="cd_prod"                  column="cdProd"/> 
            <result property="cd_it"                    column="cdIt"/> 
            <result property="nm_comprador"             column="nmCompradorRec"/> 
            <result property="idade"                    column="idadeRec"/> 
            <result property="nm_paciente"              column="nmPacienteRec"/> 
            <result property="receita_tipo"             column="receitaTipoRec"/> 
            <result property="cid"          			column="cidRec"/> 
            <result property="uf"                       column="ufRec"/> 
            <result property="nr_doc_cli"               column="nrDocCliRec"/> 
            <result property="tipo_documento"           column="tipoDocumentoRec"/> 
            <result property="cd_medico_rec" 			column="cdMedicoRec"/> 
            <result property="qt_prod"                  column="qtProd"/> 
            <result property="dt_receita"               column="dtReceita"/> 
            <result property="tp_capt_receita"          column="tipoCaptacaoReceita"/>                     
	</resultMap>	
              
	<resultMap id="OrcamentoItemLote" type="Map">
		<result property="cd_lote"                column="cdLote"/>
        <result property="qtde_lote"              column="qtdeLote"/>                       
	</resultMap>	
	
  <update id="consumeOrcamento" parameterType="Map">
    update est_orc set flag_consolidado = 1 , sts_orc = 1 where CD_EMP = #{cdEmp} and CD_FILIAL = #{cdFilial} and CD_ORC = #{cdOrc}
  </update>
  
  <select id="selectOrcamentoCplFalta" resultMap="OrcamentoCplFalta">
	<![CDATA[
	
			select 
				'estOrcFalta' as "tipoRegistro",
				cd_falta ,
				cd_prod ,
				cd_filial ,
				qtde ,
				dt_falta ,
				cd_vend ,
				qtde_estoque ,
				COALESCE(tp_falta,0::NUMERIC) as "tp_falta",
				COALESCE(nm_concorrente,' '::CHARACTER VARYING) as "nm_concorrente",
				COALESCE(vlr_preco_concorrente::money::numeric::float8,0.0::money::numeric::float8) as "vlr_preco_concorrente"
			FROM est_orc_cpl_falta 
			where flag_consolidado = 0 LIMIT 1;

		]]>
  </select>
  
  <resultMap id="OrcamentoCplFalta" type="Map">
		<result property="cd_falta"                column="cdFalta"/>
        <result property="cd_prod"              column="cdProd"/>     
		<result property="cd_filial"              column="cdFilial"/>    
		<result property="qtde"                column="qtde"/>
        <result property="dt_falta"              column="dtFalta"/>     
		<result property="cd_vend"              column="cdVend"/> 
		<result property="qtde_estoque"              column="qtdeEstoque"/>    
		<result property="tp_falta"                column="tpFalta"/>
        <result property="nm_concorrente"              column="nmConcorrente"/>     
		<result property="vlr_preco_concorrente"              column="vlrPrecoConcorrente"/>
		<result property="tipoRegistro" column="tipoRegistro"/>	
	</resultMap>
	
  <update id="consumeOrcamentoCplFalta" parameterType="Map">
    update est_orc_cpl_falta set flag_consolidado = 1  where cd_falta = #{cdFalta}
  </update>

</mapper>
