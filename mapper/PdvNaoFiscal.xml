<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CupomNaoFiscal">
	<select id="selectCupomNaoFiscal" resultMap="cupomNaoFiscal">
		<![CDATA[
                 SELECT    filial.cgc						             AS "CNPJ_FILIAL",
						   cupom.cd_emp                                                      ,
                           cupom.cd_filial                                                   ,
						   cupom.cd_ctr                                                      ,
                           cupom.cd_cx                                                       ,
                           cupom.dt_cupom                                                    ,
                           cupom.dt_cad                                                      ,
                           CAST(dt_cupom AS DATE) + pg_catalog.time(hr_cupom) as hr_cupom    ,
                           cupom.tp_cupom_nao_fiscal                                         ,
                           cupom.cd_mov                                                      ,
                           cupom.cd_ctr                                                      ,
                           cupom.nr_coo                                                      ,
                           cupom.st_cupom                                                    ,
                           cupom.cont_cupom_fisc                                             ,
                           cupom.cd_mov                                                      ,
                           filial.cgc                                                        ,
                           filial.nm_fant                                                    ,
                           cupom.vlr_to_cupom                                                ,
                           cupom.vlr_dinh                                                    ,
                           cupom.vlr_cartao                                                  ,
                           cupom.vlr_chqs_a_vista + cupom.vlr_chqs_a_prz                     AS "vlrChqs",
                           cupom.cd_oper_cel                                                 ,
                           cupom.nr_cel_recarga                                              ,
                           cupom.vlr_recarga_cel                                             ,
                           cupom.nm_oper_cel                                                 ,
                           cupom.nr_serie_imp                                                ,
                           cupom.vs_pdv                                                      ,
                           cupom.vs_pdv_rc                                                   ,
                           operador.cd_usu                                                   ,
                           operador.nm_usu                                                   ,
                           NULLIF(COALESCE(cupom.vlr_dinh, 0::       NUMERIC) <> 0::NUMERIC, FALSE) AS "contemDinheiro",
                           NULLIF(COALESCE(cupom.vlr_recarga_cel, 0::NUMERIC) <> 0::NUMERIC, FALSE) AS "contemRecargaCel",
                           NULLIF(cupom.st_cupom <> 0::NUMERIC, FALSE)                              AS "isCancelado",
                           cupom.tp_cupom_nao_fiscal = 0::NUMERIC                                   AS "isFatura",
                           cupom.tp_cupom_nao_fiscal = 1::NUMERIC                                   AS "isDoacao",
                           cupom.tp_cupom_nao_fiscal = 2::NUMERIC                                   AS "isDiversos",
                           cupom.tp_cupom_nao_fiscal = 3::NUMERIC                                   AS "isRecarga",
                           cupom.cd_ctr                                                             ,
                           entidade.cd_entid                                                        ,
                           entidade.nm_entid                                                        ,
						   coalesce(cupom.obs_cupom, ''::CHARACTER varying) 						AS "obsCupom", 
                           coalesce(cupom.cd_mt_sangria, 0::NUMERIC)        						AS "cdMtSangria", 
                           cupom.cd_cli                                     						, 
						   diversos.dt_vencto                                                       ,
                           CASE 
                                     WHEN diversos.cd_recb_pdv <> 0 THEN diversos.cd_recb_pdv 
                                     ELSE 0::bigint 
                           END                                              AS "diversosId", 
                           diversos.ident_recb_pdv                          ,
                           0                                                AS "stVd", 
						   cupom.st_pend_estorno                            
						    
                 FROM      pdv_cupom_nao_fiscal cupom 
                 left join prc_filial filial 
                 ON        cupom.cd_emp = filial.cd_emp 
                 AND       cupom.cd_filial = filial.cd_filial 
                 left join pdv_cupom_nao_fiscal_est_recb_pdv diversos 
                 ON        cupom.cd_emp = diversos.cd_emp 
                 AND       cupom.cd_filial = diversos.cd_filial 
                 AND       cupom.cd_cx = diversos.cd_cx 
                 AND       cupom.cd_ctr = diversos.cd_ctr 
                 left join pdv_cupom_nao_fiscal_est_entid_doacao doacao 
                 ON        cupom.cd_emp = doacao.cd_emp 
                 AND       cupom.cd_filial = doacao.cd_filial 
                 AND       cupom.cd_cx = doacao.cd_cx 
                 AND       cupom.cd_ctr = doacao.cd_ctr 
                 left join est_entidade_doacao entidade 
                 ON        doacao.cd_emp = entidade.cd_emp::NUMERIC 
                 AND       doacao.cd_entid = entidade.cd_entid 
                 left join glb_usu operador 
                 ON        cupom.cd_usu = operador.cd_usu 
                 WHERE     cupom.st_cupom >= 0::NUMERIC 
				 and cupom. vlr_to_cupom > 0
                 AND       cupom.flag_consolidado = #{flagConsolid}::numeric
                 AND        CAST(dt_cupom AS DATE) + pg_catalog.time(hr_cupom) < (now() - interval '5 minutes')  limit 1
				 
]]>
	</select>
	<select id="selectCupomNaoFiscalBaixa" resultMap="selectCupomNaoFiscalBaixa">
		<if test="isFatura == 1">
		    SELECT 
			    cupom.cd_emp			,
			    cupom.cd_filial         ,
			    cupom.cd_cx             ,
			    cupom.cd_ctr            ,
			    cupom.hash_protocolo         			
			from
                pdv_cupom_nao_fiscal cupom
			where 
                cupom.cd_emp            = #{cdEmp}
			    AND   cupom.cd_filial   = #{cdFilial}
			    AND   cupom.cd_cx       = #{cdCx}
			    AND   cupom.cd_ctr      = #{cdCtr} 
		</if>
	</select>
	<select id="selectCupomNaoFiscalBaixaFatura" resultMap="selectCupomNaoFiscalBaixaFatura">
        SELECT 
		    fatura.cd_ctr_pgto                        ,
            fatura.cd_rc_deb                          ,
		    fatura.dt_vencto				    	  ,
            fatura.vlr_sld_dp                         ,
            fatura.vlr_sld_dp                         ,
            fatura.vlr_min_pgto                       ,
            fatura.vlr_pago                           ,                         
            1 as st_paga                              ,
            fatura.tp_pgto_offline                    ,
            fatura.vlrjuros                           ,
            fatura.vlrdesconto                        ,
            fatura.nrfatura                                                                         						   
		FROM 
            pdv_cupom_nao_fiscal_rec_fatura fatura 
		WHERE   
            #{cdEmp}        = fatura.cd_emp 
		    AND #{cdFilial} = fatura.cd_filial 
		    AND #{cdCx}     = fatura.cd_cx 
		    AND #{cdCtr}    = fatura.cd_ctr 

	</select>
	<select id="selectCupomNaoFiscalBaixaParcela" resultMap="selectCupomNaoFiscalBaixaParcela">
			SELECT 
                parcela.cd_ctr_pgto						        ,
                parcela.cd_ctr_parc                             ,
                parcela.vlr_parc                                ,
                parcela.vlr_pago                                ,
                1 as st_paga                                    ,
                parcela.tp_pgto_offline                         
			FROM
                pdv_cupom_nao_fiscal_rec_parc_cred parcela 
			WHERE
                #{cdEmp}        = parcela.cd_emp 
                AND #{cdFilial} = parcela.cd_filial 
                AND #{cdCx}     = parcela.cd_cx 
                AND #{cdCtr}    = parcela.cd_ctr 
	</select>
	<select id="selectCupomNaoFiscalCheque" resultMap="selectCupomNaoFiscalCheque">
		SELECT chq.cd_bc_chq       ,
			   chq.nr_ord          ,
			   chq.nr_chq          ,
			   chq.ano_chq         ,
			   chq.vlr_chq         ,
			   (extract(epoch from #{dtEmi}::timestamp)::bigint ) * 1000 AS "dtEmi",
			   chq.dt_vencto       ,
			   chq.ag_chq          ,
			   chq.cpf_cgc_emi     ,
			   chq.nm_emi          ,
			   chq.fone_emi        ,
			   chq.nr_cnt_chq      ,
			   chq.aut_chq         ,
			   chq.comp_chq        ,
			   chq.c1_chq          ,
			   chq.c2_chq          ,
			   chq.sr_chq          ,
			   chq.cmc7_chq        ,
			   chq.mes_ano_cnt_chq 
		FROM   
            pdv_cupom_nao_fiscal_chqs chq                                                                                
		WHERE
            #{cdEmp}            = chq.cd_emp
		    AND    #{cdFilial}  = chq.cd_filial
		    AND    #{cdCtr}     = chq.cd_ctr
		    AND    #{cdCx}      = chq.cd_cx
	</select>
	<select id="selectCupomNaoFiscalCartao" resultMap="selectCupomNaoFiscalCartao">	
		<![CDATA[ SELECT     cupomtef.cd_trn_tef AS "cdRectoTef",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN
                                                                                                             CASE
                                                                                                                       WHEN coalesce(cupomtef.cd_adm_cartao, 0::NUMERIC) > 0::NUMERIC THEN cupomtef.cd_adm_cartao
                                                                                                                       WHEN cupomtef.cd_adm_cartao = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm = 6 THEN
                                                                                                                                 (
                                                                                                                                        SELECT rc_adm_cartao.cd_adm_cartao
                                                                                                                                        FROM   rc_adm_cartao
                                                                                                                                        WHERE  rc_adm_cartao.cd_emp = cupomtef.cd_emp
                                                                                                                                        AND    rc_adm_cartao.tp_adm = cupomtef.tp_adm::NUMERIC
                                                                                                                                        AND    rc_adm_cartao.parc = cupomtef.qt_parc:: NUMERIC
                                                                                                                                        AND    rc_adm_cartao.sts_adm = 0 limit 1)
                                                                                                                       WHEN cupomtef.cd_adm_cartao = 0::NUMERIC THEN 0::NUMERIC
                                                                                                                       ELSE NULL::                      NUMERIC
                                                                                                             END
                                                                                                   ELSE
                                                                                                             CASE
                                                                                                                       WHEN coalesce(pdvtef.cd_adm_cartao, 0::NUMERIC) > 0::NUMERIC THEN
                                                                                                                                 CASE
                                                                                                                                           WHEN coalesce(pdvtef.ds_bandeira, ''::CHARACTER varying)::text = ''::text
                                                                                                                                           AND       pdvtef.cd_adm_cartao = 0::NUMERIC THEN
                                                                                                                                                     (
                                                                                                                                                            SELECT rc_adm_cartao.cd_adm_cartao
                                                                                                                                                            FROM   rc_adm_cartao
                                                                                                                                                            WHERE  rc_adm_cartao.nm_usual::text ~~* '%OPERADORA NAO CLASSIFICADA%'::text limit 1)
                                                                                                                                           ELSE pdvtef.cd_adm_cartao
                                                                                                                                 END
                                                                                                                       WHEN pdvtef.cd_adm_cartao = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm = 6 THEN
                                                                                                                                 (
                                                                                                                                        SELECT rc_adm_cartao.cd_adm_cartao
                                                                                                                                        FROM   rc_adm_cartao
                                                                                                                                        WHERE  rc_adm_cartao.cd_emp = cupomtef.cd_emp
                                                                                                                                        AND    rc_adm_cartao.tp_adm = cupomtef.tp_adm::NUMERIC
                                                                                                                                        AND    rc_adm_cartao.parc = cupomtef.qt_parc:: NUMERIC
                                                                                                                                        AND    rc_adm_cartao.sts_adm = 0 limit 1)
                                                                                                                       WHEN pdvtef.cd_adm_cartao = 0::NUMERIC THEN 0::NUMERIC
                                                                                                                       ELSE NULL::                    NUMERIC
                                                                                                             END
                                                                                         END AS "cdConv",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN
                                                                                                             CASE
                                                                                                                       WHEN coalesce(cupomtef.cd_adm_cartao, 0::NUMERIC) > 0::NUMERIC THEN adm.nm_usual
                                                                                                                       WHEN coalesce(cupomtef.cd_adm_cartao, 0::NUMERIC) = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm <> 6 THEN cupomtef.ds_bandeira
                                                                                                                       WHEN cupomtef.cd_adm_cartao = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm = 6 THEN
                                                                                                                                 (
                                                                                                                                        SELECT rc_adm_cartao.nm_usual
                                                                                                                                        FROM   rc_adm_cartao
                                                                                                                                        WHERE  rc_adm_cartao.cd_emp = cupomtef.cd_emp
                                                                                                                                        AND    rc_adm_cartao.tp_adm = cupomtef.tp_adm::NUMERIC
                                                                                                                                        AND    rc_adm_cartao.parc = cupomtef.qt_parc:: NUMERIC
                                                                                                                                        AND    rc_adm_cartao.sts_adm = 0 limit 1)
                                                                                                                       ELSE NULL::CHARACTER varying
                                                                                                             END
                                                                                                   ELSE
                                                                                                             CASE
                                                                                                                       WHEN coalesce(pdvtef.cd_adm_cartao, 0::NUMERIC) > 0::NUMERIC THEN
                                                                                                                                 CASE
                                                                                                                                           WHEN coalesce(pdvtef.ds_bandeira, ''::CHARACTER varying)::text = ''::text
                                                                                                                                           AND       pdvtef.cd_adm_cartao = 0::NUMERIC THEN
                                                                                                                                                     (
                                                                                                                                                            SELECT rc_adm_cartao.nm_usual
                                                                                                                                                            FROM   rc_adm_cartao
                                                                                                                                                            WHERE  rc_adm_cartao.nm_usual::text ~~* '%OPERADORA NAO CLASSIFICADA%'::text limit 1)
                                                                                                                                           ELSE
                                                                                                                                                 (
                                                                                                                                                 SELECT rc_adm_cartao.nm_usual
                                                                                                                                                 FROM   rc_adm_cartao
                                                                                                                                                 WHERE  rc_adm_cartao.cd_emp = pdvtef.cd_emp
                                                                                                                                                 AND    rc_adm_cartao.cd_adm_cartao = pdvtef.cd_adm_cartao)
                                                                                                                                 END
                                                                                                                       WHEN pdvtef.cd_adm_cartao = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm = 6 THEN
                                                                                                                                 (
                                                                                                                                        SELECT rc_adm_cartao.nm_usual
                                                                                                                                        FROM   rc_adm_cartao
                                                                                                                                        WHERE  rc_adm_cartao.cd_emp = cupomtef.cd_emp
                                                                                                                                        AND    rc_adm_cartao.tp_adm = cupomtef.tp_adm::NUMERIC
                                                                                                                                        AND    rc_adm_cartao.parc = cupomtef.qt_parc:: NUMERIC
                                                                                                                                        AND    rc_adm_cartao.sts_adm = 0 limit 1)
                                                                                                                       WHEN pdvtef.cd_adm_cartao = 0::NUMERIC THEN coalesce(pdvtef.ds_bandeira, 'OPERADORA NAO CLASSIFICADA'::CHARACTER varying)
                                                                                                                       ELSE NULL::CHARACTER varying
                                                                                                             END
                                                                                         END AS "nmConv",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN
                                                                                                             CASE
                                                                                                                       WHEN coalesce(cupomtef.cd_adm_cartao, 0::NUMERIC) > 0::NUMERIC THEN adm.nm_usual
                                                                                                                       WHEN coalesce(cupomtef.cd_adm_cartao, 0::NUMERIC) = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm <> 6 THEN cupomtef.ds_bandeira
                                                                                                                       WHEN cupomtef.cd_adm_cartao = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm = 6 THEN
                                                                                                                                 (
                                                                                                                                        SELECT rc_adm_cartao.nm_usual
                                                                                                                                        FROM   rc_adm_cartao
                                                                                                                                        WHERE  rc_adm_cartao.cd_emp = cupomtef.cd_emp
                                                                                                                                        AND    rc_adm_cartao.tp_adm = cupomtef.tp_adm::NUMERIC
                                                                                                                                        AND    rc_adm_cartao.parc = cupomtef.qt_parc:: NUMERIC
                                                                                                                                        AND    rc_adm_cartao.sts_adm = 0 limit 1)
                                                                                                                       ELSE NULL::CHARACTER varying
                                                                                                             END
                                                                                                   ELSE
                                                                                                             CASE
                                                                                                                       WHEN coalesce(pdvtef.cd_adm_cartao, 0::NUMERIC) > 0::NUMERIC THEN
                                                                                                                                 CASE
                                                                                                                                           WHEN coalesce(pdvtef.ds_bandeira, ''::CHARACTER varying)::text = ''::text
                                                                                                                                           AND       pdvtef.cd_adm_cartao = 0::NUMERIC THEN
                                                                                                                                                     (
                                                                                                                                                            SELECT rc_adm_cartao.nm_usual
                                                                                                                                                            FROM   rc_adm_cartao
                                                                                                                                                            WHERE  rc_adm_cartao.nm_usual::text ~~* '%OPERADORA NAO CLASSIFICADA%'::text limit 1)
                                                                                                                                           ELSE
                                                                                                                                                 (
                                                                                                                                                 SELECT rc_adm_cartao.nm_usual
                                                                                                                                                 FROM   rc_adm_cartao
                                                                                                                                                 WHERE  rc_adm_cartao.cd_emp = pdvtef.cd_emp
                                                                                                                                                 AND    rc_adm_cartao.cd_adm_cartao = pdvtef.cd_adm_cartao)
                                                                                                                                 END
                                                                                                                       WHEN pdvtef.cd_adm_cartao = 0::NUMERIC
                                                                                                                       AND       cupomtef.tp_adm = 6 THEN
                                                                                                                                 (
                                                                                                                                        SELECT rc_adm_cartao.nm_usual
                                                                                                                                        FROM   rc_adm_cartao
                                                                                                                                        WHERE  rc_adm_cartao.cd_emp = cupomtef.cd_emp
                                                                                                                                        AND    rc_adm_cartao.tp_adm = cupomtef.tp_adm::NUMERIC
                                                                                                                                        AND    rc_adm_cartao.parc = cupomtef.qt_parc:: NUMERIC
                                                                                                                                        AND    rc_adm_cartao.sts_adm = 0 limit 1)
                                                                                                                       WHEN pdvtef.cd_adm_cartao = 0::NUMERIC THEN coalesce(pdvtef.ds_bandeira, 'OPERADORA NAO CLASSIFICADA'::CHARACTER varying)
                                                                                                                       ELSE NULL::CHARACTER varying
                                                                                                             END
                                                                                         END AS "bandeira",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN cupomtef.vl_saque_cartao
                                                                                                   ELSE pdvtef.vl_saque_cartao
                                                                                         END AS "vlrSaque",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN coalesce(cupomtef.qt_parc, 1)
                                                                                                   ELSE
                                                                                                             CASE
                                                                                                                       WHEN pdvtef.qt_parc > 0 THEN pdvtef.qt_parc
                                                                                                                       ELSE 1
                                                                                                             END
                                                                                         END AS "qtParc",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN cupomtef.cod_rede
                                                                                                   ELSE pdvtef.cod_rede
                                                                                         END AS "codRede",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN cupomtef.cod_bandeira
                                                                                                   ELSE pdvtef.cod_bandeira
                                                                                         END AS "codBandeira",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN
                                                                                                             CASE
                                                                                                                       WHEN coalesce(cupomtef.cod_modalidade, '0'::CHARACTER varying)::text = '0'::text
                                                                                                                       OR        cupomtef.cod_modalidade::text = 0::text THEN '9800'::CHARACTER varying
                                                                                                                       ELSE cupomtef.cod_modalidade
                                                                                                             END
                                                                                                   ELSE
                                                                                                             CASE
                                                                                                                       WHEN coalesce(pdvtef.cod_modalidade, '0'::CHARACTER varying)::text = '0'::text
                                                                                                                       OR        pdvtef.cod_modalidade::text = 0::text THEN '9800'::CHARACTER varying
                                                                                                                       ELSE pdvtef.cod_modalidade
                                                                                                             END
                                                                                         END AS "codModalidade",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::                   NUMERIC THEN "substring"(cupomtef.nsu_tef::text, 0, 9)::NUMERIC 
                                                                                                   ELSE "substring"(pdvtef.nsu_sitef::text, 0, 9)::NUMERIC 
                                                                                         END AS "nrTransacao",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN "substring"(cupomtef.nr_autorizacao::text, 0, 16) 
                                                                                                   ELSE "substring"(pdvtef.nr_autorizacao::text, 0, 16) 
                                                                                         END AS "nrAutorizacao",
                                                                                         CASE 
                                                                                                   WHEN cupomtef.gerenciador_tef = 1 THEN 'SCOPE'::text
                                                                                                   WHEN cupomtef.trn_pos = 1 THEN 'POS'::text
                                                                                                   ELSE 'SITEF'::text
                                                                                         END                                 AS "tefGateway",
                                                                                         
                                                                                         CASE 
                                                                                                   WHEN cupomtef.vl_cartao > 0::NUMERIC THEN
                                                                                                             CASE
                                                                                                                       WHEN pdvtef.cd_adm_cartao > 0::   NUMERIC
                                                                                                                       AND       cupomtef.vl_cartao > 0::NUMERIC THEN cupomtef.vl_cartao
                                                                                                                       ELSE
                                                                                                                                 CASE
                                                                                                                                           WHEN coalesce(cupomtef.cod_modalidade, '9800'::CHARACTER varying)::text = '9800'::text
                                                                                                                                           OR        cupomtef.cod_modalidade::text = 0::text THEN 0.00
                                                                                                                                           ELSE cupomtef.vl_cartao
                                                                                                                                 END
                                                                                                             END
                                                                                                   ELSE
                                                                                                             CASE
                                                                                                                       WHEN pdvtef.cd_adm_cartao > 0:: NUMERIC
                                                                                                                       AND       pdvtef.vl_cartao > 0::NUMERIC THEN pdvtef.vl_cartao
                                                                                                                       ELSE
                                                                                                                                 CASE
                                                                                                                                           WHEN coalesce(pdvtef.cod_modalidade, '9800'::CHARACTER varying)::text = '9800'::text
                                                                                                                                           OR        pdvtef.cod_modalidade::text = 0::text THEN 0.00
                                                                                                                                           ELSE pdvtef.vl_cartao
                                                                                                                                 END
                                                                                                             END
                                                                                         END AS "vlrCartao"
                                                                               FROM      pdv_cupom_nao_fiscal_tef cupomtef                                                                              
                                                                               left join rc_adm_cartao adm
                                                                               ON        cupomtef.cd_emp = adm.cd_emp
                                                                               AND       cupomtef.cd_adm_cartao = adm.cd_adm_cartao
                                                                               left join pdv_recbto_tef pdvtef
                                                                               ON        cupomtef.cd_emp = pdvtef.cd_emp
                                                                               AND       cupomtef.cd_filial = pdvtef.cd_filial
                                                                               AND       cupomtef.cd_cx = pdvtef.cd_cx
                                                                               AND       cupomtef.cd_recto_tef = pdvtef.cd_recto_tef
																			   
                                                                               WHERE     (cupomtef.vl_cartao > 0::NUMERIC OR pdvtef.vl_cartao > 0::  NUMERIC)
																			   AND (pdvtef.cod_modalidade::text <> '9800'::text OR cupomtef.cod_modalidade::text <> '9800'::text)
                                                                               AND       #{cdEmp} = cupomtef.cd_emp
                                                                               AND       #{cdFilial} = cupomtef.cd_filial
                                                                               AND       #{cdCx} = cupomtef.cd_cx
                                                                               AND       #{cdCtr} = cupomtef.cd_ctr]]>
	</select>
	<update id="consumePdvNaoFiscal" parameterType="Map">
        update pdv_cupom_nao_fiscal set flag_consolidado = 2 where CD_EMP = #{cdEmp} and CD_FILIAL = #{cdFilial} and cd_cx = #{cdCx} and cd_ctr = #{cdCtr}
	</update>
	<update id="consumePdvNaoFiscalReprocessar" parameterType="Map">
        update pdv_cupom_nao_fiscal set flag_consolidado = 0 where CD_EMP = #{cdEmp} and CD_FILIAL = #{cdFilial} and cd_cx = #{cdCx} and cd_ctr = #{cdCtr}
	</update>
    <update id="consumePdvNaoFiscalReprocessarTodos" parameterType="Map">
        <![CDATA[  update pdv_cupom_nao_fiscal set flag_consolidado = 0 where flag_consolidado = 2 and  st_cupom = 0  AND CAST(dt_cupom AS DATE) + pg_catalog.time(hr_cupom) < (now() - interval '25 minutes') ]]>
	</update>
	<select id="selectConciliacaoPdvCupomNaoFiscal" resultMap="selectConciliacaoPdvCupomNaoFiscal">
		select 'pdvCupomNaoFiscalConciliacao' as "tipoRegistro"
	</select>
	<select id="selectConciliacaoPdvCupomNaoFiscalCupons" resultMap="selectConciliacaoPdvCupomNaoFiscalCupons">
        <![CDATA[	select  cd_emp 	,
                            cd_filial 	,
                            cd_cx 		,
                            nr_coo 		,
                            dt_cupom 		,
                            st_cupom 		,
                            cd_ctr
                        from 
                            pdv_cupom_nao_fiscal 
                        where 
                            cd_emp = 1 
                            and cd_filial in ( (select cd_filial from prc_filial) ) 
                            and CAST(dt_cupom AS DATE) + pg_catalog.time(hr_cupom) >= (now() - interval '6 hours' ) 
                            and st_cupom = 0 
                            and vlr_to_cupom > 0 
                ]]>
	</select>
	<resultMap id="cupomNaoFiscal" type="Map"> 	
		<result property="cnpjFilial" column="CNPJ_FILIAL"/>
		<result property="cdEmp" column="CD_EMP"/> 
		<result property="cdFilial" column="CD_FILIAL"/> 
		<result property="cdCx" column="CD_CX"/> 
		<result property="cdCtr" column="CD_CTR"/> 
		<result property="dtCupom" column="dt_cupom"/>	
		<result property="dtCad" column="dt_cad"/>	
		<result property="hrCupom" column="hr_cupom"/>	
		<result property="tpCupom" column="tp_cupom_nao_fiscal"/>	
		<result property="cdMov" column="cd_mov"/>	
		<result property="cdCtr" column="cd_ctr"/>	
		<result property="nrCoo" column="nr_coo"/>	
		<result property="stCupom" column="st_cupom"/>	
		<result property="contadorCupomFiscal" column="cont_cupom_fisc"/>	
		<result property="codigoMovimento" column="cd_mov"/>	
		<result property="cgcFilial" column="cgc"/>	
		<result property="nmFilial" column="nm_fant"/>	
		<result property="vlrTotCupom" column="vlr_to_cupom"/>	
		<result property="vlrDinh" column="vlr_dinh"/>	
		<result property="vlrCartao" column="vlr_cartao"/>	
		<result property="vlrChqs" column="vlrChqs"/>	
		<result property="cdOperCel" column="cd_oper_cel"/>	
		<result property="nrCelRecarga" column="nr_cel_recarga"/>	
		<result property="vlrRecargaCel" column="vlr_recarga_cel"/>	
		<result property="nmOperCel" column="nm_oper_cel"/>	
		<result property="nrSerieEcf" column="nr_serie_imp"/>	
		<result property="versaoPdv" column="vs_pdv"/>	
		<result property="versaoPdvRc" column="vs_pdv_rc"/>	
		<result property="cdOperador" column="cd_usu"/>	
		<result property="nmOperador" column="nm_usu"/>	
		<result property="contemDinheiro" column="contemDinheiro"/>	
		<result property="contemRecargaCel" column="contemRecargaCel"/>	
		<result property="isCancelado" column="isCancelado"/>	
		<result property="isFatura" column="isFatura"/>	
		<result property="isDoacao" column="isDoacao"/>	
		<result property="isDiversos" column="isDiversos"/>	
		<result property="isRecarga" column="isRecarga"/>	
		<result property="doacaoId" column="cd_ctr"/>	
		<result property="doacaoFavorId" column="cd_entid"/>	
		<result property="doacaoFavorNome" column="nm_entid"/>	
		<result property="obsCupom" column="obsCupom"/>	 
		<result property="cdMtSangria" column="cdMtSangria"/>	 
		<result property="cdCli" column="cd_cli"/>	 
		<result property="diversosVenc" column="dt_vencto"/>
		<result property="diversosId" column="diversosId"/>	 
		<result property="diversosCodigo" column="ident_recb_pdv"/>	
		<result property="stVd" column="stVd"/>	 
		<result property="stPendEstorno" column="st_pend_estorno"/>	
		<association property="pagamento" javaType="Map">			
			<collection property="cheque" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdCx=CD_CX,cdCtr=CD_CTR,dtEmi=DT_CAD}" javaType="ArrayList" ofType="map" select="selectCupomNaoFiscalCheque" />	
			<collection property="cartao" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdCx=CD_CX,cdCtr=CD_CTR}" javaType="ArrayList" ofType="map" select="selectCupomNaoFiscalCartao" />		
		</association>
		<association property="baixaDeFatura" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdCx=CD_CX,cdCtr=CD_CTR,isFatura=isFatura}" javaType="Map" select="selectCupomNaoFiscalBaixa"	/> 		
	</resultMap>
	<resultMap id="selectCupomNaoFiscalBaixa" type="Map"> 
		<result property="cdEmp" column="CD_EMP"/> 
		<result property="cdFilial" column="CD_FILIAL"/> 
		<result property="cdCx" column="CD_CX"/> 
		<result property="cdCtr" column="CD_CTR"/>
		<result property="hashProtocolo" column="hash_protocolo"/>	
		<collection property="faturas" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdCx=CD_CX,cdCtr=CD_CTR}" javaType="ArrayList" ofType="map" select="selectCupomNaoFiscalBaixaFatura" />	
		<collection property="parcelas" column="{cdEmp=CD_EMP,cdFilial=CD_FILIAL,cdCx=CD_CX,cdCtr=CD_CTR}" javaType="ArrayList" ofType="map" select="selectCupomNaoFiscalBaixaParcela" />	
	</resultMap>
	<resultMap id="selectCupomNaoFiscalBaixaFatura" type="Map"> 
		<result property="faturaRecId" column="cd_ctr_pgto"/>	
		<result property="faturaId" column="cd_rc_deb"/>	
		<result property="dtVencto" column="dt_vencto"/>	
		<result property="faturaVlr" column="vlr_sld_dp"/>	
		<result property="faturaVlrSld" column="vlr_sld_dp"/>	
		<result property="faturaVlrMin" column="vlr_min_pgto"/>	
		<result property="faturaVlrCred" column="vlr_pago"/>	                         
		<result property="faturaStPaga" column="st_paga"/>	
		<result property="faturaOffline" column="tp_pgto_offline"/>	
		<result property="faturavlrJuro" column="vlrjuros"/>	
		<result property="faturaVlrDesc" column="vlrdesconto"/>	
		<result property="faturaNrFatura" column="nrfatura"/>	
	</resultMap>	
	<resultMap id="selectCupomNaoFiscalBaixaParcela" type="Map">
		<result property="parcelaRecId" column="cd_ctr_pgto"/>	
		<result property="parcelaId" column="cd_ctr_parc"/>	
		<result property="parcelaVlr" column="vlr_parc"/>	
		<result property="parcelaVlrCred" column="vlr_pago"/>	
		<result property="parcelaStPaga" column="st_paga"/>	 
		<result property="parcelaOffline" column="tp_pgto_offline"/>
	</resultMap>
	<resultMap id="selectCupomNaoFiscalCheque" type="Map">
		<result property="cdBc" column="cd_bc_chq"/>	
		<result property="nrOrd" column="nr_ord"/>	
		<result property="nrChq" column="nr_chq"/>	
		<result property="anoChq" column="ano_chq"/>	
		<result property="vlrChq" column="vlr_chq"/>	
		<result property="dtEmi" column="dtEmi"/>	
		<result property="dtVencto" column="dt_vencto"/>	
		<result property="agChq" column="ag_chq"/>	
		<result property="cgcEmi" column="cpf_cgc_emi"/>	
		<result property="nmEmi" column="nm_emi"/>	
		<result property="foneEmi" column="fone_emi"/>	
		<result property="nrCntChq" column="nr_cnt_chq"/>	
		<result property="autChq" column="aut_chq"/>	
		<result property="compChq" column="comp_chq"/>	
		<result property="c1Chq" column="c1_chq"/>	
		<result property="c2Chq" column="c2_chq"/>	
		<result property="c3Chq" column="sr_chq"/>	
		<result property="cmc7Chq" column="cmc7_chq"/>	
		<result property="mesAnoCntChq" column="mes_ano_cnt_chq"/>
	</resultMap>
	<resultMap id="selectCupomNaoFiscalCartao" type="Map">
		<result property="cdRectoTef" column="cdRectoTef"/> 
		<result property="cdConv" column="cdConv"/> 
		<result property="nmConv" column="nmConv"/> 
		<result property="bandeira" column="bandeira"/> 
		<result property="qtParc" column="qtParc"/> 
		<result property="codRede" column="codRede"/> 
		<result property="codBandeira" column="codBandeira"/> 
		<result property="codModalidade" column="codModalidade"/> 
		<result property="nrTransacao" column="nrTransacao"/> 
		<result property="nrAutorizacao" column="nrAutorizacao"/> 
		<result property="tefGateway" column="tefGateway"/> 
		<result property="vlrCartao" column="vlrCartao"/> 
	</resultMap>
	<resultMap id="selectConciliacaoPdvCupomNaoFiscal" type="Map">	
		<result property="tipoRegistro" column="tipoRegistro"/>
		<collection property="cupons" column="tipoRegistro=tipoRegistro" javaType="ArrayList" ofType="map" select="selectConciliacaoPdvCupomNaoFiscalCupons" />		
	</resultMap>
	<resultMap id="selectConciliacaoPdvCupomNaoFiscalCupons" type="Map">	
		<result property="cdEmp" column="cd_emp"/>	
		<result property="cdFilial" column="cd_filial"/>	
		<result property="cdCx" column="cd_cx"/>	
		<result property="nrCoo" column="nr_coo"/>	
		<result property="dtCupom" column="dt_cupom"/>	
		<result property="stCupom" column="st_cupom"/>	
        <result property="cdCtrLoja" column="cd_ctr"/>		
	</resultMap>
</mapper>

